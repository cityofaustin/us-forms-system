{"version":3,"sources":["../../../../src/js/widgets/SelectLocation/SelectLocationWidget.jsx"],"names":["HERE_APP_ID","HERE_APP_CODE","MAPBOX_TOKEN","GEOCODE_DEBUG","Map","accessToken","geocoderControl","MapboxGeocoder","placeholder","bbox","limit","trackProximity","SelectLocationWidget","props","locationUpdated","bind","onChange","onStyleLoad","onMoveEnd","onDragStart","onDragEnd","onForwardGeocodeResult","location","value","JSON","parse","address","position","lng","lat","state","center","showPin","geocodeAddressString","formValue","geocodeResult","result","place_name","setState","map","dragRotate","disable","touchZoomRotate","disableRotation","zoomControl","NavigationControl","addControl","on","updateGeocoderProximity","getZoom","getCenter","wrap","setProximity","longitude","latitude","setCenter","resize","lngLat","addressString","newFormValue","locationJSON","stringify","setInput","mapboxURL","hereURL","fetch","then","provider","response","status","console","error","json","mapboxAddress","data","features","info","hereAddress","Response","View","Result","Location","Address","Label","passGeocodedResult","reverseGeocode","pinDrop","Component"],"mappings":"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","file":"SelectLocationWidget.js","sourcesContent":["import React, { Component } from 'react';\nimport ReactMapboxGl, { Layer } from 'react-mapbox-gl';\nimport { NavigationControl } from 'mapbox-gl';\nimport MapboxGeocoder from '@mapbox/mapbox-gl-geocoder';\n\nconst HERE_APP_ID = 'R3EtGwWQmTKG5eVeyLV8';\nconst HERE_APP_CODE = '8aDkNeOzfxGFkOKm9fER0A';\nconst MAPBOX_TOKEN = 'pk.eyJ1IjoiY3Jvd2VhdHgiLCJhIjoiY2o1NDFvYmxkMHhkcDMycDF2a3pseDFpZiJ9.UcnizcFDleMpv5Vbv8Rngw';\nconst GEOCODE_DEBUG = false;\n\nconst Map = ReactMapboxGl({\n  accessToken: MAPBOX_TOKEN\n});\n\nconst geocoderControl = new MapboxGeocoder({\n  accessToken: MAPBOX_TOKEN,\n  placeholder: 'Enter a location here',\n\n  // bounding box restricts results to Travis County\n  bbox: [-98.173053, 30.02329, -97.369564, 30.627918],\n  // or texas\n  // bbox: [65,25.84,-93.51,36.5],\n  // or by country:\n  // countries: 'us',\n  limit: 5,\n  trackProximity: true\n});\n\nexport default class SelectLocationWidget extends Component {\n  constructor(props) {\n    super(props);\n\n    this.locationUpdated = this.locationUpdated.bind(this);\n    this.onChange = this.onChange.bind(this);\n    this.onStyleLoad = this.onStyleLoad.bind(this);\n    this.onMoveEnd = this.onMoveEnd.bind(this);\n    this.onDragStart = this.onDragStart.bind(this);\n    this.onDragEnd = this.onDragEnd.bind(this);\n    this.onForwardGeocodeResult = this.onForwardGeocodeResult.bind(this);\n\n    // take location data from the form if it exists, or use a default\n    const location = props.value\n      ? JSON.parse(props.value)\n      : {\n        address: 'default',\n        position: {\n          lng: null,\n          lat: null\n        }\n      };\n\n    this.state = {\n      center: [location.position.lng || -97.7460479736328, location.position.lat || 30.266184073558826],\n      showPin: true,\n      geocodeAddressString: location.address,\n      formValue: props.value || ''\n    };\n  }\n\n  onForwardGeocodeResult(geocodeResult) {\n    const address = geocodeResult.result.place_name;\n    this.setState({ geocodeAddressString: address });\n  }\n\n  onDragStart() {\n    this.setState({\n      showPin: false\n    });\n  }\n\n  onDragEnd() {\n    this.setState({\n      geocodeAddressString: null,\n      showPin: true\n    });\n  }\n\n  onStyleLoad(map) {\n    // disable map rotation using right click + drag\n    map.dragRotate.disable();\n    // disable map rotation using touch rotation gesture\n    map.touchZoomRotate.disableRotation();\n\n    const zoomControl = new NavigationControl();\n    map.addControl(zoomControl, 'bottom-right');\n    map.addControl(geocoderControl, 'top-left');\n\n    geocoderControl.on('result', this.onForwardGeocodeResult);\n\n    function updateGeocoderProximity() {\n      // proximity is designed for local scale, if the user is looking at the whole world,\n      // it doesn't make sense to factor in the arbitrary centre of the map\n      if (map.getZoom() > 9) {\n        const center = map.getCenter().wrap(); // ensures the longitude falls within -180 to 180 as the Geocoding API doesn't accept values outside this range\n        geocoderControl.setProximity({\n          longitude: center.lng,\n          latitude: center.lat\n        });\n      } else {\n        geocoderControl.setProximity(null);\n      }\n    }\n\n    map.on('load', updateGeocoderProximity); // set proximity on map load\n    map.on('moveend', updateGeocoderProximity); // and then update proximity each time the map moves\n    map.setCenter(this.state.center);\n    map.resize();\n  }\n\n  onMoveEnd(map) {\n    const center = map.getCenter();\n    this.locationUpdated({ lngLat: center, addressString: this.state.geocodeAddressString });\n  }\n\n  // calls us-forms-system onChange to propogate values up to the form\n  onChange(newFormValue) {\n    this.props.onChange(newFormValue);\n    this.setState({ formValue: newFormValue });\n  }\n\n  // prepare geocoded result to be propogated to form\n  passGeocodedResult({ lngLat, addressString }) {\n    const location = {\n      address: addressString === 'default' ? null : addressString,\n      position: lngLat\n    };\n    const locationJSON = JSON.stringify(location);\n    this.onChange(locationJSON);\n    // update the geocoder input box with the address label\n    if (addressString !== 'default') {\n      geocoderControl.setInput(location.address);\n    }\n  }\n\n  reverseGeocode({ lngLat }) {\n    // eslint-disable-next-line no-unused-vars\n    const mapboxURL = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lngLat.lng}%2C${lngLat.lat}.json?access_token=${MAPBOX_TOKEN}`;\n    // eslint-disable-next-line no-unused-vars\n    const hereURL = `https://reverse.geocoder.api.here.com/6.2/reversegeocode.json?prox=${lngLat.lat}%2C${lngLat.lng}%2C250&mode=retrieveAddresses&maxresults=1&gen=9&app_id=${HERE_APP_ID}&app_code=${HERE_APP_CODE}`;\n    if (GEOCODE_DEBUG) {\n      fetch(mapboxURL).then(response => {\n        const provider = 'mapbox: ';\n        if (response.status !== 200) {\n          console.error(`Looks like there was a problem. Status Code: ${response.status}`);\n          return;\n        }\n\n        response.json().then(data => {\n          const mapboxAddress = data.features[0].place_name;\n          console.info(provider + JSON.stringify(data));\n          console.info(mapboxAddress);\n        });\n      });\n\n      fetch(hereURL).then(response => {\n        const provider = 'HERE: ';\n        if (response.status !== 200) {\n          console.error(`Looks like there was a problem. Status Code: ${response.status}`);\n          return;\n        }\n\n        response.json().then(data => {\n          const hereAddress = data.Response.View[0].Result[0].Location.Address.Label;\n          console.info(provider + JSON.stringify(data));\n          console.info(hereAddress);\n        });\n      });\n    }\n    fetch(hereURL).then(response => {\n      if (response.status !== 200) {\n        console.error(`Looks like there was a problem. Status Code: ${response.status}`);\n        const address = 'Dropped Pin';\n        this.passGeocodedResult({ lngLat, addressString: address });\n        return;\n      }\n\n      response.json().then(data => {\n        const hereAddress = data.Response.View[0].Result[0].Location.Address.Label;\n        const address = hereAddress;\n        this.passGeocodedResult({ lngLat, addressString: address });\n      });\n    });\n  }\n\n  locationUpdated({ lngLat, addressString }) {\n    // If we have an address string, skip calling the reverse geocoder\n    if (addressString) {\n      this.passGeocodedResult({ lngLat, addressString });\n      return;\n    }\n\n    this.reverseGeocode({ lngLat });\n  }\n\n  render() {\n    const pinDrop = this.state.showPin ? 'show' : 'hide';\n\n    return (\n      <div>\n        <div className=\"map-container\">\n          <Map\n            // eslint-disable-next-line react/style-prop-object\n            style={'mapbox://styles/croweatx/cjow5d6cd3l7g2snrvf17wf0r'}\n            onStyleLoad={this.onStyleLoad}\n            onDragStart={this.onDragStart}\n            onDragEnd={this.onDragEnd}\n            onMoveEnd={this.onMoveEnd}>\n            <Layer\n              type=\"symbol\"\n              id=\"selectedLocation\"\n              layout={{\n                'icon-image': 'marker-open-small',\n                'icon-allow-overlap': true\n              }}/>\n\n            <div className={`pin ${pinDrop}`}/>\n            <div className=\"pulse\"/>\n          </Map>\n        </div>\n      </div>\n    );\n  }\n}\n"]}
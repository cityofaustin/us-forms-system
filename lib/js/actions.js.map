{"version":3,"sources":["../../src/js/actions.js"],"names":["closeReviewChapter","openReviewChapter","setData","setEditMode","setSubmission","setPreSubmit","setSubmitted","setViewedPages","submitToUrl","submitForm","uploadFile","SET_EDIT_MODE","SET_DATA","SET_VIEWED_PAGES","SET_PRE_SUBMIT","SET_SUBMISSION","SET_SUBMITTED","OPEN_REVIEW_CHAPTER","CLOSE_REVIEW_CHAPTER","closedChapter","pageKeys","type","openedChapter","data","page","edit","index","field","value","extra","preSubmitField","preSubmitAccepted","response","body","submitUrl","recordEvent","Promise","resolve","reject","req","XMLHttpRequest","open","addEventListener","status","event","responseBody","responseText","results","JSON","parse","error","Error","statusText","parseInt","getResponseHeader","setRequestHeader","send","formConfig","form","console","log","bind","dispatch","promise","submit","transformForSubmit","then","resp","catch","errorReceived","errorMessage","String","message","errorType","startsWith","file","uiOptions","onProgress","onChange","onError","getState","size","maxSize","name","minSize","fileTypes","some","toLowerCase","endsWith","fileType","uploading","payload","createPayload","formId","fileUploadUrl","fileData","parseResponse","resetDate","Date","upload","evt","lengthComputable","loaded","total"],"mappings":"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","file":"actions.js","sourcesContent":["import { transformForSubmit } from './helpers';\nimport { timeFromNow } from './utilities/date';\n\nexport const SET_EDIT_MODE = 'SET_EDIT_MODE';\nexport const SET_DATA = 'SET_DATA';\nexport const SET_VIEWED_PAGES = 'SET_VIEWED_PAGES';\nexport const SET_PRE_SUBMIT = 'SET_PRE_SUBMIT';\nexport const SET_SUBMISSION = 'SET_SUBMISSION';\nexport const SET_SUBMITTED = 'SET_SUBMITTED';\nexport const OPEN_REVIEW_CHAPTER = 'OPEN_REVIEW_CHAPTER';\nexport const CLOSE_REVIEW_CHAPTER = 'CLOSE_REVIEW_CHAPTER';\n\nexport function closeReviewChapter(closedChapter, pageKeys = []) {\n  return {\n    type: CLOSE_REVIEW_CHAPTER,\n    closedChapter,\n    pageKeys\n  };\n}\n\nexport function openReviewChapter(openedChapter) {\n  return {\n    type: OPEN_REVIEW_CHAPTER,\n    openedChapter\n  };\n}\n\nexport function setData(data) {\n  return {\n    type: SET_DATA,\n    data\n  };\n}\n\nexport function setEditMode(page, edit, index = null) {\n  return {\n    type: SET_EDIT_MODE,\n    edit,\n    page,\n    index\n  };\n}\n\n// extra is used to pass other information (from a submission error or anything else)\n// into the submission state object\nexport function setSubmission(field, value, extra = null) {\n  return {\n    type: SET_SUBMISSION,\n    field,\n    value,\n    extra\n  };\n}\n\nexport function setPreSubmit(preSubmitField, preSubmitAccepted) {\n  return {\n    type: SET_PRE_SUBMIT,\n    preSubmitField,\n    preSubmitAccepted\n  };\n}\n\nexport function setSubmitted(response) {\n  return {\n    type: SET_SUBMITTED,\n    response: typeof response.data !== 'undefined' ? response.data : response\n  };\n}\n\n\nexport function setViewedPages(pageKeys) {\n  return {\n    type: SET_VIEWED_PAGES,\n    pageKeys\n  };\n}\n\nexport function submitToUrl(body, submitUrl, recordEvent) {\n  return new Promise((resolve, reject) => {\n    const req = new XMLHttpRequest();\n    req.open('POST', submitUrl);\n    req.addEventListener('load', () => {\n      if (req.status >= 200 && req.status < 300) {\n        recordEvent({ event: 'form-submit-successful' });\n\n        // got this from the fetch polyfill, keeping it to be safe\n        const responseBody = 'response' in req ? req.response : req.responseText;\n        const results = JSON.parse(responseBody);\n        resolve(results);\n      } else {\n        let error;\n        if (req.status === 429) {\n          error = new Error(`throttled_error: ${req.statusText}`);\n          error.extra = parseInt(req.getResponseHeader('x-ratelimit-reset'), 10);\n        } else {\n          error = new Error(`server_error: ${req.statusText}`);\n        }\n        error.statusText = req.statusText;\n        reject(error);\n      }\n    });\n\n    req.addEventListener('error', () => {\n      const error = new Error('client_error: Network request failed');\n      error.statusText = req.statusText;\n      reject(error);\n    });\n\n    req.addEventListener('abort', () => {\n      const error = new Error('client_error: Request aborted');\n      error.statusText = req.statusText;\n      reject(error);\n    });\n\n    req.addEventListener('timeout', () => {\n      const error = new Error('client_error: Request timed out');\n      error.statusText = req.statusText;\n      reject(error);\n    });\n\n    req.setRequestHeader('Content-Type', 'application/json');\n\n    req.send(body);\n  });\n}\n\nexport function submitForm(formConfig, form) {\n  const recordEvent = formConfig.recordEvent ?\n    formConfig.recordEvent :\n    console.log.bind(console);      // eslint-disable-line no-console\n\n  return dispatch => {\n    dispatch(setSubmission('status', 'submitPending'));\n    recordEvent({ event: 'form-submit-pending' });\n\n    let promise;\n    if (formConfig.submit) {\n      promise = formConfig.submit(form, formConfig);\n    } else {\n      const body = formConfig.transformForSubmit\n        ? formConfig.transformForSubmit(formConfig, form)\n        : transformForSubmit(formConfig, form);\n\n      promise = submitToUrl(body, formConfig.submitUrl, recordEvent);\n    }\n\n    return promise\n      .then(resp => dispatch(setSubmitted(resp)))\n      .catch(errorReceived => {\n        // overly cautious\n        const error = errorReceived instanceof Error ? errorReceived : new Error(errorReceived);\n        const errorMessage = String(error.message);\n        let errorType = 'clientError';\n        if (errorMessage.startsWith('throttled_error')) {\n          errorType = 'throttledError';\n        } else if (errorMessage.startsWith('server_error')) {\n          errorType = 'serverError';\n        }\n        recordEvent({ event: 'form-submit-error', error, errorType });\n        dispatch(setSubmission('status', errorType, error.extra));\n      });\n  };\n}\n\nexport function uploadFile(file, uiOptions, onProgress, onChange, onError) {\n  return (dispatch, getState) => {\n    if (file.size > uiOptions.maxSize) {\n      onChange({\n        name: file.name,\n        errorMessage: 'File is too large to be uploaded'\n      });\n\n      onError();\n      return null;\n    }\n\n    if (file.size < uiOptions.minSize) {\n      onChange({\n        name: file.name,\n        errorMessage: 'File is too small to be uploaded'\n      });\n\n      onError();\n      return null;\n    }\n\n    // we limit file types, but it’s not respected on mobile and desktop\n    // users can bypass it without much effort\n    if (!uiOptions.fileTypes.some(fileType => file.name.toLowerCase().endsWith(fileType.toLowerCase()))) {\n      onChange({\n        name: file.name,\n        errorMessage: 'File is not one of the allowed types'\n      });\n\n      onError();\n      return null;\n    }\n\n    onChange({\n      name: file.name,\n      uploading: true\n    });\n\n    const payload = uiOptions.createPayload(file, getState().form.formId);\n\n    const req = new XMLHttpRequest();\n\n    req.open('POST', uiOptions.fileUploadUrl);\n    req.addEventListener('load', () => {\n      if (req.status >= 200 && req.status < 300) {\n        const body = 'response' in req ? req.response : req.responseText;\n        const fileData = uiOptions.parseResponse(JSON.parse(body), file);\n        onChange(fileData);\n      } else {\n        let errorMessage = req.statusText;\n        if (req.status === 429) {\n          const resetDate = new Date(req.getResponseHeader('x-ratelimit-reset') * 1000);\n          errorMessage = `You’ve reached the limit for the number of submissions we can accept at this time. Please try again in ${timeFromNow(resetDate)}.`;\n        }\n\n        onChange({\n          name: file.name,\n          errorMessage\n        });\n        onError();\n      }\n    });\n\n    req.addEventListener('error', () => {\n      const errorMessage = 'Network request failed';\n      onChange({\n        name: file.name,\n        errorMessage\n      });\n      onError();\n    });\n\n    req.upload.addEventListener('progress', (evt) => {\n      if (evt.lengthComputable && onProgress) {\n        // setting this at 80, because there's some time after we get to 100%\n        // where the backend is uploading to s3\n        onProgress((evt.loaded / evt.total) * 80);\n      }\n    });\n\n    req.setRequestHeader('X-Key-Inflection', 'camel');\n    req.send(payload);\n\n    return req;\n  };\n}\n"]}